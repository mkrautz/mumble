#! /usr/bin/perl
#
# Copyright 2005-2016 The Mumble Developers. All rights reserved.
# Use of this source code is governed by a BSD-style license
# that can be found in the LICENSE file at the root of the
# Mumble source tree or at <https://www.mumble.info/LICENSE>.

use warnings;
use strict;
use Carp;

sub licenseFileToVar($$) {
  my ($var,$file)=@_;

  my $ret;


  open(IN, $file) or croak;
  my $l = join("", <IN>);
  $l =~ s/\r//g;
  $l =~ s/\f//g;
  $l =~ s/\"/\\\"/g;

  $l = join("\\n\"\n\t\"",split(/\n/, $l));

  return qq!static const char *${var} = \n\t\"! . $l . "\";\n";
}

sub printGuarded($$$) {
  my ($F, $S, $Guard)=@_;
  
  if ($Guard) {
    print $F "#ifdef " . $Guard . "\n";
  }
  print $F $S;
  
  if ($Guard) {
    print $F "#endif\n";
  }
}


open(my $F, "> ../src/mumble/licenses.h");
binmode $F; # Ensure consistent file endings across platforms

print $F "/*\n";
print $F " * This file was auto-generated by scripts/mklic.pl\n";
print $F " * DO NOT EDIT IT MANUALLY\n";
print $F " */\n";
print $F "#ifndef MUMBLE_MUMBLE_LICENSES_H_\n";
print $F "#define MUMBLE_MUMBLE_LICENSES_H_\n";
print $F "\n";
print $F "#include <QtGlobal>\n";
print $F "\n";
print $F "struct ThirdPartyLicense {\n";
print $F "	const char* name;\n";
print $F "	const char* url;\n";
print $F "	const char* license;\n";
print $F "\n";
print $F "	ThirdPartyLicense() : name(0), url(0), license(0) {}\n";
print $F "	ThirdPartyLicense(const char* name_, const char* url_, const char* license_)\n";
print $F "	    : name(name_), url(url_), license(license_) {}\n";
print $F "	bool isEmpty() const { return (name == 0 && url == 0 && license == 0); }\n";
print $F "};\n";
print $F "\n";


print $F licenseFileToVar("licenseMumble", "../LICENSE");
print $F "\n\n";

# List of 3rd party licenses  [<variableName>, <pathToLicenseFile>, <DisplayName>, <URL>]
my @thirdPartyLicenses = (
    ["licenseCELT", "../3rdparty/celt-0.11.0-src/COPYING", "CELT", "http://www.celt-codec.org/"],
    ["licenseOpus", "../3rdparty/opus-src/COPYING", "Opus", "http://www.opus-codec.org/"],
    ["licenseSPEEX", "../3rdparty/speex-src/COPYING", "Speex", "http://www.speex.org/"],
    ["licenseOpenSSL", "../3rdPartyLicenses/openssl_license.txt", "OpenSSL", "http://www.openssl.org/"],
    ["licenseLibsndfile", "../3rdPartyLicenses/libsndfile_license.txt", "libsndfile", "http://www.mega-nerd.com/libsndfile/"],
    ["licenseOgg", "../3rdPartyLicenses/libogg_license.txt", "libogg", "http://www.xiph.org/"],
    ["licenseVorbis", "../3rdPartyLicenses/libvorbis_license.txt", "libvorbis", "http://www.xiph.org/"],
    ["licenseFLAC", "../3rdPartyLicenses/libflac_license.txt", "libFLAC", "http://flac.sourceforge.net/"],
    ["licenseMachOverride", "../3rdPartyLicenses/mach_override_license.txt", "mach_override", "https://github.com/rentzsch/mach_star", "Q_OS_MAC"],
    ["licenseMinHook", "../3rdPartyLicenses/minhook_license.txt", "MinHook", "https://github.com/TsudaKageyu/minhook", "Q_OS_WIN64"],
    ["licenseQtTranslations", "../src/mumble/qttranslations/LICENSE",
        "Additional Qt translations", "https://www.virtualbox.org/ticket/2018", "USING_BUNDLED_QT_TRANSLATIONS"],
    ["licenseFilterSvg", "../icons/filter.txt", "filter.svg icon", "https://commons.wikimedia.org/wiki/File:Filter.svg"],
    ["licenseEmojiOne", "../3rdPartyLicenses/cc_by_sa_40_legalcode.txt", "Emoji One artwork", "http://emojione.com/"],
    ["licenseXInputCheck", "../3rdparty/xinputcheck-src/COPYING.txt", "XInputCheck (SDL_IsXInput function)", "https://www.libsdl.org/"],
    ["licenseQQBonjour", "../3rdparty/qqbonjour-src/LICENSE", "QQBonjour", "https://doc.qt.io/archives/qq/qq23-bonjour.html"],
    ["licenseSmallFT", "../3rdparty/smallft-src/LICENSE", "smallft", "https://www.xiph.org"],

    # Mumble old-style licenses
    ["licenseMumbleAudioConfigDialog", "../3rdPartyLicenses/mumble/mumble-audioconfigdialog.txt", "Mumble's AudioConfigDialog", "https://www.mumble.info"],
    ["licenseMumbleGKey", "../3rdPartyLicenses/mumble/mumble-gkey.txt", "Support for GKey in Mumble", "https://www.mumble.info"],
    ["licenseMumblePAAudio", "../3rdPartyLicenses/mumble/mumble-paaudio.txt", "Support for PortAudio in Mumble", "https://www.mumble.info"],
    ["licenseMumbleTTSMacx", "../3rdPartyLicenses/mumble/mumble-texttospeech-macx.txt", "Mumble's Text-to-Speech support on OS X", "https://www.mumble.info"],
    ["licenseMumbleUserLocalVolumeDialog", "../3rdPartyLicenses/mumble/mumble-userlocalvolumedialog.txt", "Mumble's UserLocalVolumeDialog", "https://www.mumble.info"],
    ["licenseMurmurPBKDF2", "../3rdPartyLicenses/mumble/murmur-pbkdf2.txt", "Murmur's PBKDF2 support", "https://www.mumble.info"],
    ["licenseOverlayD11StateBlock", "../3rdPartyLicenses/mumble/overlay-d11stateblock.txt", "D11StateBlock in Mumble's Windows Overlay", "https://www.mumble.info"],
    ["licenseOverlayD3D11HLSLShaders", "../3rdPartyLicenses/mumble/overlay-d3d11-hlsl-shaders.txt", "D3D11 HLSL shaders for Mumble's Windows Overlay", "https://www.mumble.info"],
    ["licenseOverlayD3D11", "../3rdPartyLicenses/mumble/overlay-d3d11.txt", "D3D11 support for Mumble's Windows Overlay", "https://www.mumble.info"],
    ["licenseOverlayDXGI", "../3rdPartyLicenses/mumble/overlay-dxgi.txt", "DXGI support for Mumble's Windows Overlay", "https://www.mumble.info"],
    ["licensePluginAOC", "../3rdPartyLicenses/mumble/plugins-aoc.txt", "Mumble's \"Age of Chivalry\" Plugin", "https://www.mumble.info"],
    ["licensePluginsARMA2", "../3rdPartyLicenses/mumble/plugins-arma2.txt", "Mumble's \"Arma 2\" Plugin", "https://www.mumble.info"],
    ["licensePluginsBF1942", "../3rdPartyLicenses/mumble/plugins-bf1942.txt", "Mumble's \"Battlefield 1942\" Plugin", "https://www.mumble.info"],
    ["licensePluginsBF3", "../3rdPartyLicenses/mumble/plugins-bf3.txt", "Mumble's \"Battlefield 3\" Plugin", "https://www.mumble.info"],
    ["licensePluginsBFBC2", "../3rdPartyLicenses/mumble/plugins-bfbc2.txt", "Mumble's \"Battlefield: Bad Company 2\" Plugin", "https://www.mumble.info"],
    ["licensePluginsBlacklight", "../3rdPartyLicenses/mumble/plugins-blacklight.txt", "Mumble's \"Blacklight\" Plugin", "https://www.mumble.info"],
    ["licensePluginsBorderlands", "../3rdPartyLicenses/mumble/plugins-borderlands.txt", "Mumble's \"Borderlands\" Plugin", "https://www.mumble.info"],
    ["licensePluginsBorderlands2", "../3rdPartyLicenses/mumble/plugins-borderlands2.txt", "Mumble's \"Borderlands 2\" Plugin", "https://www.mumble.info"],
    ["licensePluginsBreach", "../3rdPartyLicenses/mumble/plugins-breach.txt", "Mumble's \"Breach\" Plugin", "https://www.mumble.info"],
    ["licensePluginsCODMW2", "../3rdPartyLicenses/mumble/plugins-codmw2.txt", "Mumble's \"Call of Duty: Modern Warfare 2\" Plugin", "https://www.mumble.info"],
    ["licensePluginsCODMW2SO", "../3rdPartyLicenses/mumble/plugins-codmw2so.txt", "Mumble's \"Call of Duty: Modern Warfare 2 Special Ops\" Plugin", "https://www.mumble.info"],
    ["licensePluginsCS", "../3rdPartyLicenses/mumble/plugins-cs.txt", "Mumble's \"Counter-Strike\" Plugin", "https://www.mumble.info"],
    ["licensePluginsDys", "../3rdPartyLicenses/mumble/plugins-dys.txt", "Mumble's \"Dystopia\" Plugin", "https://www.mumble.info"],
    ["licensePluginsETQW", "../3rdPartyLicenses/mumble/plugins-etqw.txt", "Mumble's \"Enemy Territory: Quake Wars\" Plugin", "https://www.mumble.info"],
    ["licensePluginsGMOD", "../3rdPartyLicenses/mumble/plugins-gmod.txt", "Mumble's \"Garry's Mod\" Plugin", "https://www.mumble.info"],
    ["licensePluginsGTAIV", "../3rdPartyLicenses/mumble/plugins-gtaiv.txt", "Mumble's \"Grand Theft Auto IV\" Plugin", "https://www.mumble.info"],
    ["licensePluginsInsurgency", "../3rdPartyLicenses/mumble/plugins-insurgency.txt", "Mumble's \"Insurgency\" Plugin", "https://www.mumble.info"],
    ["licensePluginsJC2", "../3rdPartyLicenses/mumble/plugins-jc2.txt", "Mumble's \"Just Cause 2\" Plugin", "https://www.mumble.info"],
    ["licensePluginsL4D2", "../3rdPartyLicenses/mumble/plugins-l4d2.txt", "Mumble's \"Left 4 Dead 2 \" Plugin", "https://www.mumble.info"],
    ["licensePluginsLOL", "../3rdPartyLicenses/mumble/plugins-lol.txt", "Mumble's \"League of Legends\" Plugin", "https://www.mumble.info"],
    ["licensePluginsLOTRO", "../3rdPartyLicenses/mumble/plugins-lotro.txt", "Mumble's \"The Lord of the Rings Online\" Plugin", "https://www.mumble.info"],
    ["licenseSR", "../3rdPartyLicenses/mumble/plugins-sr.txt", "Mumble's \"Sub Rosa\" Plugin", "https://www.mumble.info"],
    ["licenseUT2004", "../3rdPartyLicenses/mumble/plugins-ut2004.txt", "Mumble's \"Unreal Tournament 2004\" Plugin", "https://www.mumble.info"],
    ["licenseUT3", "../3rdPartyLicenses/mumble/plugins-ut3.txt", "Mumble's \"Unreal Tournament 3\" Plugin", "https://www.mumble.info"],
    ["licenseUT99", "../3rdPartyLicenses/mumble/plugins-ut99.txt", "Mumble's \"Unreal Tournament\" Plugin", "https://www.mumble.info"],
    ["licenseWoW", "../3rdPartyLicenses/mumble/plugins-wow.txt", "Mumble's \"World of Warcraft\" Plugin", "https://www.mumble.info"],
);

# Print 3rd party licenses
foreach (@thirdPartyLicenses) {
    printGuarded($F, licenseFileToVar(@$_[0], @$_[1]), @$_[4]);
    print $F "\n\n";
}


# Print list of 3rd party licenses
print $F "static const ThirdPartyLicense licenses3rdParties[] = {\n";
foreach (@thirdPartyLicenses) {
    printGuarded($F, "\tThirdPartyLicense(\"" . @$_[2] . "\", \"" . @$_[3] . "\", " . @$_[0] . "),\n", @$_[4]);
}
# Empty entry that marks the end of the array
printGuarded($F, "\tThirdPartyLicense(),\n", @$_[4]);
print $F "};\n\n\n";

print $F "#endif\n";

close($F);
